---
title: "Actuarial 3 Tarea 1"
subtitle: "Actuarial 3"
lang: es
author: "Marcelino Sánchez"
date: today
format:
  html:
    page-layout: full
    embed-resources: true
editor_options: 
  chunk_output_type: console
---

# Ejercicio 1

Se sabe que el monto de las reclamaciones de un seguro de crédito es Exponencial con media de 80 mil pesos, y que el número de reclamaciones de cada uno de los 48 asegurado (Nj) es ( )Po λ e independiente de los demás. En este seguro cada asegurado puede hacer más de una reclamación, pero la probabilidad de ese evento es de sólo 0.0265. La prima recargada agregada (bajo el principio de la desviación estándar) se define por \[ \] \[ \]E S S α ασΠ = + , donde 0 α ≥ es el margen de seguridad.

ii) ¿Cuál es la prima recargada individual que se debe cobrar a cada asegurado si se considera un margen de seguridad de 0.5? ¿Cómo se compara frente a la respectiva prima neta individual? \[10\]

```{r}
mediaDistPerd <- 80

varDistPerd <- 80^2

# Averiguando valor de lambda

funcionLambda <- function(lambda){
  return((1+lambda)*exp(-lambda)-1+.0265)
}

# Encontrar la raíz usando uniroot
resultado <- uniroot(funcionLambda, interval = c(0, 1))

# Imprimir el resultado
cat("El valor de lambda que hace que la función sea aproximadamente cero es:", resultado$root, "\n")

#Prima recargada

mediaDistFrec <- 48*resultado$root

vardDistFrec <- 48*resultado$root

esperanzaS <- mediaDistPerd*mediaDistFrec

varianzaS <- varDistPerd*mediaDistFrec + vardDistFrec*mediaDistPerd^2

paramRecargada <- 0.5

primaRecargada <- 1000*(esperanzaS+paramRecargada*sqrt(varianzaS))/48

cat("La prima recargada agregada es:",primaRecargada , "\n")

cat("La prima recargada individual es:", (primaRecargada/48)*1000, "\n")

primaNetaIndividual <-  (esperanzaS/48)*1000

cat("La prima neta individual es:", primaNetaIndividual, "\n")

cat("Con lo cual la recargada es ",primaRecargada/primaNetaIndividual, " veces la neta", "\n" )

```

iii) Aproxime la distribución de S mediante el Teorema Central del Límite para encontrar el margen de seguridad que garantice con 99.5% de probabilidad que la prima recargada agregada será suficiente para hacer frente a las obligaciones de este seguro. ¿Cuál sería la prima recargada individual en este caso? \[10\]

```{r}
# Aproximación de la distribución de S mediante el TCL

# Ya tenemos la media y varianza de S

# Calculamos la alfa que nos da el 99.5% de seguridad

alfa <- qnorm(0.995)

# Calculamos la prima recargada

(primaRecargada <- (esperanzaS+alfa*sqrt(varianzaS))*1000)

(primaRecargadaInd <- (primaRecargada/48))
```

# Ejercicio 2

```{r}
# Cargamos librerías

library(readxl)
library(openxlsx)
library(lubridate)
library(dplyr)  # Load the dplyr package for data manipulation
library(ggplot2)


```

```{r cargando datos_1}
# Set the path to the Excel file and the sheet name

file_path <- paste0(getwd(), "/bases/Tarea1.xlsx")
sheet_name <- "2"

# Read the entire sheet into a data frame
sheet <- read_excel(file_path, sheet = sheet_name, range = "A7:D427")

# Extract year and month from the Fecha column
sheet$Month <- lubridate::month(sheet$Fecha)
sheet$Year <- lubridate::year(sheet$Fecha)
sheet$Day <- lubridate::day(sheet$Fecha)

sheet$Year <- as.factor(sheet$Year)
sheet$Month <- as.factor(sheet$Month)
sheet$Ramo <- as.factor(sheet$Ramo)

# Print the table
head(sheet)
summary(sheet)

```

b)  Construya una gráfica que permita analizar la evolución mensual del número de reclamaciones por ramo de 2020 a 2022

```{r}
# Create a grid of all possible Year, Month, and Ramo combinations
all_combinations <- expand.grid(Year = unique(sheet$Year),
                                Month = unique(sheet$Month),
                                Ramo = unique(sheet$Ramo)) %>%
                                arrange(Year, Month, Ramo)

# Agrupamos los datos por año, mes y ramo

agg_data <- sheet %>%
  group_by(Year, Month, Ramo) %>%
  summarise(Num_Reclamaciones = n())

# Left join the grid with your data
grouped_data <- all_combinations %>%
  left_join(agg_data, by = c("Year", "Month", "Ramo")) %>%
  mutate(Num_Reclamaciones = ifelse(is.na(Num_Reclamaciones), 0, Num_Reclamaciones)) 

# Create the plot with faceting by year and connected lines across months
ggplot(grouped_data, aes(x = as.Date(paste(Year, Month, "01", sep = "-")), y = Num_Reclamaciones, color = Ramo, group = Ramo)) +
  geom_line() +
  geom_vline(aes(xintercept = as.Date(paste(Year, "01-01", sep = "-"))), color = "black", linetype = "dashed") +
  labs(x = "Mes", y = "Número de reclamaciones", color = "Ramo") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability

```

c)  Con la información de los 3 años construya 4 histogramas de los montos individuales de los siniestros de cada uno de los ramos. \[10\]

```{r}
# Cargar el paquete necesario
library(ggplot2)

# Crear los histogramas

ggplot(sheet, aes(x = Monto)) +
  geom_histogram(bins = 10) +
  facet_wrap(~ Ramo, scales = "free" ) +
  labs(x = "Monto", y = "Frecuencia") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability

```

d)  Se quiere analizar exclusivamente el ramo Catastrófico de 2020 a 2022:
e)  Grafique el proceso de siniestros agregados. \[10\]

```{r}
catSheet <- sheet %>%
  filter(Ramo == "Catastrofico") %>%
  mutate(acumMonto = cumsum(Monto))

ggplot(catSheet, aes(x = as.Date(paste(Year, Month, Day, 
sep = "-")), y = acumMonto)) + geom_step() +
  geom_vline(aes(xintercept = as.Date(paste(Year, "01-01", sep = "-"))), color = "black", linetype = "dashed") +
  labs(x = "Mes", y = "Siniestros agregados", color = "Ramo") +
  scale_x_date(date_labels = "%d %b %Y", date_breaks = "2 month") +
  scale_y_continuous(breaks = seq(0,800, 100) ) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability

```

ii) Suponga que la aseguradora cobró como prima neta agregada el monto total de los 12 siniestros y que cobró una tercera parte al inicio de cada año a sus asegurados. Grafique el proceso de primas recolectadas. \[5\]

```{r}
prima_agregada_final <- tail(catSheet$acumMonto, 1)

prima_agregada_func <- function(x){
  return(x*prima_agregada_final/3)
}

x_values <- seq(2020, 2022,1)
y_values <- sapply(x_values+1-2020, prima_agregada_func)

# Create an igraph graph
prima_agregada_serie <-data.frame(x_values = x_values, y_values = y_values)

# Plot the graph using ggplot2
ggplot(prima_agregada_serie, aes(x = x_values, y = y_values)) +
  geom_step() +
  scale_y_continuous(breaks = seq(0,800, 100) ) +
  labs(x = "año", y = "Y", title = "Pima acumulada serie") +
  theme_minimal()
```

iii) Si la Aseguradora tenía un capital inicial para estos riesgos de 50 millones de dólares, combine los procesos anteriores para graficar el proceso de excedentes. ¿Qué puede concluir? (Sugerencia: Considere el tiempo en el que se presenta el primer excedente por debajo del capital inicial y el tiempo de ruina). \[10\]

```{r}
# Crear un data frame con los datos de los excedentes

serieMontos <- catSheet %>%
  select(Year, Month, Day, Monto)

for (i in 1:3) {
  new_row <- c(as.character(2020 + i-1), "1", "1", -prima_agregada_func(1))
  serieMontos <- rbind(serieMontos, new_row)
}

serieMontos <- serieMontos %>%
  arrange(Year, Month, Day) %>% 
  mutate(excedente = 50-cumsum(Monto))

# Filtrar rows donde el excedente es negativo y 
#donde el excedente es menor a 50  

serieMontos <- serieMontos %>%
  mutate(excedenteMenor50 = excedente < 50, 
         excedenteNegativo = excedente < 0)
print(serieMontos[serieMontos$excedenteNegativo,])
print(serieMontos[serieMontos$excedenteMenor50,])


# Extract points where excedenteNegativo is TRUE
points_excedente_negativo <- head(serieMontos[serieMontos$excedenteNegativo,],1)

# Extract points where excedenteMenor50 is TRUE
points_excedente_menor_50 <- head(serieMontos[serieMontos$excedenteMenor50,],1)

# Graficar el proceso de excedentes
ggplot(serieMontos, aes(x = as.Date(paste(Year, Month, Day, 
sep = "-")), y = excedente)) + geom_step() +
  geom_vline(aes(xintercept = as.Date(paste(Year, "01-01", sep = "-"))), color = "black", linetype = "dashed") +
  labs(x = "Mes y año", y = "Excedente") +
  scale_x_date(date_labels = "%d %b %Y", date_breaks = "1 month") +
  geom_hline(yintercept = 0, color = "red") +
  geom_hline(yintercept = 50, color = "blue") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ # Rotate x-axis labels for readability
  geom_point(data = points_excedente_negativo, aes(x = as.Date(paste(Year, Month, Day, sep = "-")), y = excedente), color = "red") +
  geom_point(data = points_excedente_menor_50, aes(x = as.Date(paste(Year, Month, Day, sep = "-")), y = excedente), color = "blue")+
  geom_text(data = points_excedente_negativo, aes(label = as.Date(paste(Day, Month, Year, sep = "-")), x = as.Date(paste(Year, Month, Day, sep = "-")), y = excedente), vjust = 1.5, color = "red") +
  geom_text(data = points_excedente_menor_50, aes(label = as.Date(paste(Day, Month, Year, sep = "-")), x = as.Date(paste(Year, Month, Day, sep = "-")), y = excedente), vjust = 1.5, color = "blue")


```

# Ejercicio 4

Situación Financiera de las Aseguradoras. 

En el archivo “Tarea 1.xls” aparecen Estados
Financieros de las 83 Compañías Aseguradoras en México al 31 de diciembre de 2022.
Considere la muestra integrada por las 25 principales Compañías Aseguradoras en términos de prima emitida para responder lo siguiente.

```{r Cargando datos_4}
# Set the path to the Excel file and the sheet name

file_path <- paste0(getwd(), "/bases/Tarea1.xlsx")
sheet_name <- "4"

# Read the entire sheet into a data frame
sheet2 <- read_excel(file_path, sheet = sheet_name, range = "A8:AP91")
```

CC a) Construya el histograma y el diagrama de caja y brazos para las inversiones como porcentaje del activo total. Interprete sus resultados en términos de la estructura financiera de las aseguradoras. [5]

```{r}

```


CC b) Construya el histograma y el diagrama de caja y brazos para las reservas técnicas
como porcentaje del pasivo total. Interprete sus resultados en términos de la
estructura financiera de las aseguradoras. [5]
CC c) Obtenga una gráfica de barras apiladas que permita comparar el tamaño de las 4
reservas técnicas como porcentaje del pasivo total para las 25 principales
aseguradoras. ¿Qué puede concluir? [10]
CC d) Analice mediante el diagrama de dispersión y el coeficiente de correlación lineal la
relación entre: (i) el margen de utilidad (resultado del ejercicio / prima emitida) vs. la
razón combinada; y (ii) el margen de utilidad vs. el porcentaje de retención (prima de
retención / prima emitida). ¿Qué pude concluir? [10]


